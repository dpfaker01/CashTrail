<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">
    
    <!-- Apple/iOS Support -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashTrail">
    
    <!-- App Info -->
    <meta name="description" content="Withdrawal-to-Expense Ledger - Track every penny from bank to spend">
    <title>CashTrail - Withdrawal to Expense Tracker</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --border-subtle: #475569;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }

        [data-theme="light"] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-subtle: #cbd5e1;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100%;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        body {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
            background: var(--bg-primary);
            position: relative;
            transition: background 0.3s;
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-subtle);
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        [data-theme="light"] .app-header {
            background: rgba(241, 245, 249, 0.95);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .icon-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--spacing-md);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .cash-hero {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .cash-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .cash-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }

        .cash-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
            font-variant-numeric: tabular-nums;
        }

        .cash-currency {
            font-size: 1rem;
            color: var(--accent-primary);
            margin-left: var(--spacing-xs);
        }

        .cash-meta {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .meta-item.positive { color: var(--accent-success); }
        .meta-item.negative { color: var(--accent-danger); }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-action {
            font-size: 0.875rem;
            color: var(--accent-primary);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .withdrawal-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .withdrawal-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .withdrawal-card:active {
            transform: scale(0.98);
        }

        .withdrawal-card.consumed {
            opacity: 0.6;
            border-color: var(--bg-tertiary);
        }

        .withdrawal-header {
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            cursor: pointer;
            transition: background 0.2s;
        }

        .withdrawal-header:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .withdrawal-id {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
            display: inline-block;
        }

        .withdrawal-source {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .withdrawal-amounts {
            text-align: right;
        }

        .withdrawal-total {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .withdrawal-remaining {
            font-size: 0.875rem;
            color: var(--accent-success);
            font-weight: 500;
        }

        .withdrawal-remaining.depleted {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .withdrawal-actions {
            display: flex;
            gap: var(--spacing-sm);
            padding: 0 var(--spacing-md) var(--spacing-md);
        }

        .btn-small {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-small:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .expense-list {
            padding: var(--spacing-md);
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border-subtle);
        }

        [data-theme="light"] .expense-list {
            background: rgba(0, 0, 0, 0.05);
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.2s;
            border-radius: var(--radius-sm);
        }

        .expense-item:hover {
            background: rgba(59, 130, 246, 0.1);
            margin: 0 -var(--spacing-sm);
            padding-left: var(--spacing-sm);
            padding-right: var(--spacing-sm);
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-info {
            flex: 1;
        }

        .expense-category {
            font-size: 0.75rem;
            color: var(--accent-warning);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.125rem;
        }

        .expense-note {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .expense-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.125rem;
        }

        .expense-amount {
            font-weight: 600;
            color: var(--accent-danger);
            font-variant-numeric: tabular-nums;
            margin-left: var(--spacing-sm);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .fab-container {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 90;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            align-items: flex-end;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab-menu {
            display: none;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .fab-menu.open {
            display: flex;
        }

        .fab-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--bg-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: var(--shadow-lg);
        }

        .fab-option-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .fab-option.withdrawal .fab-option-icon { background: var(--accent-success); }
        .fab-option.expense .fab-option-icon { background: var(--accent-danger); }
        .fab-option.adjust .fab-option-icon { background: var(--accent-warning); }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-sheet {
            background: var(--bg-secondary);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-overlay.active .modal-sheet {
            transform: translateY(0);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s;
            font-variant-numeric: tabular-nums;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .input-currency {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-currency .form-input {
            padding-left: 2.5rem;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .source-selector {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 250px;
            overflow-y: auto;
            padding: var(--spacing-sm);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
        }

        .source-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-option:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .source-option.selected {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .source-option.cash-option {
            border-style: dashed;
            background: rgba(16, 185, 129, 0.05);
        }

        .source-option.cash-option.selected {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--accent-success);
        }

        .source-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .source-info {
            display: flex;
            flex-direction: column;
        }

        .source-id {
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .source-option.cash-option .source-id {
            color: var(--accent-success);
        }

        .source-balance {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .source-radio {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-subtle);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .source-option.selected .source-radio {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
        }

        .source-option.cash-option.selected .source-radio {
            border-color: var(--accent-success);
            background: var(--accent-success);
        }

        .btn {
            width: 100%;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .history-type {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: var(--spacing-md);
        }

        .history-type.withdrawal { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        .history-type.expense { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }
        .history-type.adjustment { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }

        .history-details {
            flex: 1;
        }

        .history-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
        }

        .history-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .history-amount {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .history-amount.positive { color: var(--accent-success); }
        .history-amount.negative { color: var(--accent-danger); }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-md { margin-top: var(--spacing-md); }
        .mb-md { margin-bottom: var(--spacing-md); }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: slideIn 0.3s ease-out;
        }

        .search-container {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: var(--spacing-md) 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: var(--spacing-md);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 2.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .report-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: var(--spacing-xl);
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-xs);
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .date-range-inputs {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .date-range-inputs .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .edit-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .edit-actions .btn {
            flex: 1;
        }

        .theme-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid var(--border-subtle);
        }

        .theme-toggle.active {
            background: var(--accent-primary);
        }

        .theme-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .theme-toggle.active .theme-toggle-slider {
            transform: translateX(28px);
        }

        @media (min-width: 481px) {
            #app {
                border-left: 1px solid var(--border-subtle);
                border-right: 1px solid var(--border-subtle);
            }
        }
    </style>
<base target="_blank">
</head>
<body>
    <div id="app">
        <!-- App Header -->
        <header class="app-header">
            <div class="brand">üí∞ CashTrail</div>
            <div class="header-actions">
                <button class="icon-btn" id="btnTheme" title="Toggle Theme">üåô</button>
                <button class="icon-btn" id="btnReports" title="Reports">üìä</button>
                <button class="icon-btn" id="btnSearch" title="Search">üîç</button>
                <button class="icon-btn" id="btnHistory" title="History">üìã</button>
                <button class="icon-btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Hero -->
            <div class="cash-hero animate-in">
                <div class="cash-label">Cash on Hand</div>
                <div class="cash-amount">
                    <span id="cashAmount">0.00</span>
                    <span class="cash-currency" id="currencyDisplay">PHP</span>
                </div>
                <div class="cash-meta">
                    <div class="meta-item">
                        <span>üìä</span>
                        <span id="activeWithdrawals">0 active</span>
                    </div>
                    <div class="meta-item" id="trendIndicator">
                        <span>‚û°Ô∏è</span>
                        <span>Start tracking</span>
                    </div>
                </div>
            </div>

            <!-- Active Withdrawals Section -->
            <div class="section-header">
                <h2 class="section-title">Active Withdrawals</h2>
                <button class="section-action" id="btnViewAll">View All</button>
            </div>

            <div id="withdrawalsContainer" class="withdrawal-list">
                <!-- Dynamic content -->
            </div>

            <!-- Recent Activity Section -->
            <div class="section-header">
                <h2 class="section-title">Recent Activity</h2>
            </div>

            <div id="recentActivityContainer" class="history-list">
                <!-- Dynamic content -->
            </div>

            <div style="height: 100px;"></div>
        </main>

        <!-- Floating Action Button -->
        <div class="fab-container">
            <div class="fab-menu" id="fabMenu">
                <div class="fab-option withdrawal" onclick="app.openModal('withdrawal')">
                    <div class="fab-option-icon">‚¨áÔ∏è</div>
                    <span>Record Withdrawal</span>
                </div>
                <div class="fab-option expense" onclick="app.openModal('expense')">
                    <div class="fab-option-icon">üí∏</div>
                    <span>Record Expense</span>
                </div>
                <div class="fab-option adjust" onclick="app.openModal('adjustment')">
                    <div class="fab-option-icon">‚öñÔ∏è</div>
                    <span>Adjust Cash</span>
                </div>
            </div>
            <button class="fab" id="fabMain">+</button>
        </div>

        <!-- Modal: Withdrawal Form -->
        <div class="modal-overlay" id="modalWithdrawal">
            <div class="modal-sheet">
                <div class="modal-header">
                    <h3 class="modal-title" id="withdrawalModalTitle">Record Withdrawal</h3>
                    <button class="modal-close" onclick="app.closeModal('withdrawal')">√ó</button>
                </div>
                <div class="modal-content">
                    <form id="withdrawalForm" onsubmit="app.handleWithdrawalSubmit(event)">
                        <input type="hidden" id="withdrawalEditId">
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <div class="input-currency">
                                <span class="currency-symbol" id="withdrawalCurrency">‚Ç±</span>
                                <input type="number" class="form-input" id="withdrawalAmount" step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="withdrawalSource" required>
                                <option value="">Select source...</option>
                                <option value="BPI">BPI</option>
                                <option value="BDO">BDO</option>
                                <option value="Metrobank">Metrobank</option>
                                <option value="UnionBank">UnionBank</option>
                                <option value="GCash">GCash</option>
                                <option value="Maya">Maya</option>
                                <option value="Coins.ph">Coins.ph</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="withdrawalDate" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Reference Number (Optional)</label>
                            <input type="text" class="form-input" id="withdrawalRef" placeholder="e.g., ATM receipt number">
                            <div class="form-hint" id="withdrawalIdHint">Auto-generated ID will be shown after creation</div>
                        </div>

                        <div class="edit-actions" id="withdrawalEditActions" style="display: none;">
                            <button type="button" class="btn btn-danger" onclick="app.deleteTransaction('withdrawal', document.getElementById('withdrawalEditId').value)">Delete</button>
                            <button type="submit" class="btn btn-primary">Update Withdrawal</button>
                        </div>
                        <button type="submit" class="btn btn-primary mt-md" id="withdrawalSubmitBtn">Record Withdrawal</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal: Expense Form -->
        <div class="modal-overlay" id="modalExpense">
            <div class="modal-sheet">
                <div class="modal-header">
                    <h3 class="modal-title" id="expenseModalTitle">Record Expense</h3>
                    <button class="modal-close" onclick="app.closeModal('expense')">√ó</button>
                </div>
                <div class="modal-content">
                    <form id="expenseForm" onsubmit="app.handleExpenseSubmit(event)">
                        <input type="hidden" id="expenseEditId">
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <div class="input-currency">
                                <span class="currency-symbol" id="expenseCurrency">‚Ç±</span>
                                <input type="number" class="form-input" id="expenseAmount" step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Source *</label>
                            <div class="form-hint mb-md">Select withdrawal or use Cash on Hand:</div>
                            <div class="source-selector" id="expenseSourceSelector">
                                <!-- Dynamic source options -->
                            </div>
                            <input type="hidden" id="selectedWithdrawalId" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="expenseCategory" required>
                                <option value="">Select category...</option>
                                <option value="Food">Food & Dining</option>
                                <option value="Transport">Transportation</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Bills">Bills & Utilities</option>
                                <option value="Health">Health & Medical</option>
                                <option value="Groceries">Groceries</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Note (Optional)</label>
                            <input type="text" class="form-input" id="expenseNote" placeholder="What did you spend on?">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="expenseDate" required>
                        </div>

                        <div class="edit-actions" id="expenseEditActions" style="display: none;">
                            <button type="button" class="btn btn-danger" onclick="app.deleteTransaction('expense', document.getElementById('expenseEditId').value)">Delete</button>
                            <button type="submit" class="btn btn-primary">Update Expense</button>
                        </div>
                        <button type="submit" class="btn btn-primary mt-md" id="expenseSubmitBtn">Record Expense</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal: Cash Adjustment -->
        <div class="modal-overlay" id="modalAdjustment">
            <div class="modal-sheet">
                <div class="modal-header">
                    <h3 class="modal-title" id="adjustmentModalTitle">Adjust Cash on Hand</h3>
                    <button class="modal-close" onclick="app.closeModal('adjustment')">√ó</button>
                </div>
                <div class="modal-content">
                    <form id="adjustmentForm" onsubmit="app.handleAdjustmentSubmit(event)">
                        <input type="hidden" id="adjustmentEditId">
                        <div class="form-group">
                            <label class="form-label">Current Recorded Balance</label>
                            <div class="form-input" style="background: var(--bg-tertiary); color: var(--text-secondary);" id="currentRecordedBalance">‚Ç±0.00</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Actual Cash Count</label>
                            <div class="input-currency">
                                <span class="currency-symbol" id="adjustmentCurrency">‚Ç±</span>
                                <input type="number" class="form-input" id="adjustmentAmount" step="0.01" required placeholder="0.00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Reason for Adjustment</label>
                            <select class="form-select" id="adjustmentReason" required>
                                <option value="">Select reason...</option>
                                <option value="Miscount">Initial miscount</option>
                                <option value="Lost">Lost/missing money</option>
                                <option value="Found">Found extra cash</option>
                                <option value="Error">Recording error</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Note (Optional)</label>
                            <input type="text" class="form-input" id="adjustmentNote" placeholder="Additional details...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="adjustmentDate" required>
                        </div>

                        <div id="adjustmentPreview" class="form-group hidden">
                            <label class="form-label">Adjustment Amount</label>
                            <div class="form-input" id="adjustmentValue" style="font-weight: 600;"></div>
                        </div>

                        <div class="edit-actions" id="adjustmentEditActions" style="display: none;">
                            <button type="button" class="btn btn-danger" onclick="app.deleteTransaction('adjustment', document.getElementById('adjustmentEditId').value)">Delete</button>
                            <button type="submit" class="btn btn-primary">Update Adjustment</button>
                        </div>
                        <button type="submit" class="btn btn-primary mt-md" id="adjustmentSubmitBtn">Confirm Adjustment</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal: Search -->
        <div class="modal-overlay" id="modalSearch">
            <div class="modal-sheet" style="max-height: 95vh;">
                <div class="modal-header">
                    <h3 class="modal-title">Search Transactions</h3>
                    <button class="modal-close" onclick="app.closeModal('search')">√ó</button>
                </div>
                <div class="modal-content">
                    <div class="search-container" style="position: relative;">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search by amount, category, note, or ID..." oninput="app.handleSearch(this.value)">
                    </div>
                    <div id="searchResults" class="history-list">
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <div>Type to search transactions</div>
                            <div style="font-size: 0.875rem; margin-top: var(--spacing-sm);">
                                Search across all withdrawals, expenses, and adjustments
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Reports -->
        <div class="modal-overlay" id="modalReports">
            <div class="modal-sheet" style="max-height: 95vh;">
                <div class="modal-header">
                    <h3 class="modal-title">Spending Analytics</h3>
                    <button class="modal-close" onclick="app.closeModal('reports')">√ó</button>
                </div>
                <div class="modal-content">
                    <div class="report-filters">
                        <button class="filter-btn active" onclick="app.setReportRange('7days')">7 Days</button>
                        <button class="filter-btn" onclick="app.setReportRange('30days')">30 Days</button>
                        <button class="filter-btn" onclick="app.setReportRange('90days')">Quarter</button>
                        <button class="filter-btn" onclick="app.setReportRange('1year')">Year</button>
                        <button class="filter-btn" onclick="app.setReportRange('custom')">Custom</button>
                    </div>

                    <div id="customDateRange" class="hidden">
                        <div class="date-range-inputs">
                            <div class="form-group">
                                <label class="form-label">From</label>
                                <input type="date" class="form-input" id="reportStartDate" onchange="app.generateReport()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">To</label>
                                <input type="date" class="form-input" id="reportEndDate" onchange="app.generateReport()">
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Spent</div>
                            <div class="stat-value" id="reportTotalSpent">‚Ç±0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Transactions</div>
                            <div class="stat-value" id="reportTransactionCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Daily Average</div>
                            <div class="stat-value" id="reportDailyAvg">‚Ç±0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Top Category</div>
                            <div class="stat-value" id="reportTopCategory">-</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="spendingChart"></canvas>
                    </div>

                    <div class="section-header" style="margin-top: 0;">
                        <h3 class="section-title">Category Breakdown</h3>
                    </div>
                    <div id="categoryBreakdown" class="history-list">
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Withdrawal Details -->
        <div class="modal-overlay" id="modalWithdrawalDetails">
            <div class="modal-sheet" style="max-height: 95vh;">
                <div class="modal-header">
                    <h3 class="modal-title" id="withdrawalDetailsTitle">Withdrawal Details</h3>
                    <button class="modal-close" onclick="app.closeModal('withdrawalDetails')">√ó</button>
                </div>
                <div class="modal-content">
                    <div id="withdrawalDetailsContent">
                    </div>
                    <div id="withdrawalExpensesList" class="history-list" style="margin-top: var(--spacing-lg);">
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Settings -->
        <div class="modal-overlay" id="modalSettings">
            <div class="modal-sheet">
                <div class="modal-header">
                    <h3 class="modal-title">Settings</h3>
                    <button class="modal-close" onclick="app.closeModal('settings')">√ó</button>
                </div>
                <div class="modal-content">
                    <div class="form-group">
                        <label class="form-label">Appearance</label>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid var(--border-subtle);">
                            <span style="color: var(--text-primary);">Dark Mode</span>
                            <div class="theme-toggle" id="themeToggle" onclick="app.toggleTheme()">
                                <div class="theme-toggle-slider">üåô</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="settingsCurrency" onchange="app.updateCurrency(this.value)">
                            <option value="PHP">PHP (‚Ç±) - Philippine Peso</option>
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="EUR">EUR (‚Ç¨) - Euro</option>
                            <option value="GBP">GBP (¬£) - British Pound</option>
                            <option value="JPY">JPY (¬•) - Japanese Yen</option>
                            <option value="SGD">SGD (S$) - Singapore Dollar</option>
                            <option value="AUD">AUD (A$) - Australian Dollar</option>
                            <option value="CAD">CAD (C$) - Canadian Dollar</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Data Management</label>
                        <button type="button" class="btn btn-secondary" onclick="app.exportData()">üì• Export Data (JSON)</button>
                        <div class="mt-md">
                            <button type="button" class="btn btn-secondary" onclick="app.importData()" style="background: var(--bg-tertiary);">üì§ Import Data</button>
                        </div>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="app.handleImport(this)">
                    </div>

                    <div class="form-group mt-md">
                        <label class="form-label">Danger Zone</label>
                        <button type="button" class="btn btn-danger" onclick="app.clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>

                    <div class="form-group mt-md text-center">
                        <div class="form-hint">CashTrail v2.1.0</div>
                        <div class="form-hint">Built with ‚ù§Ô∏è for precise money tracking</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CurrencySymbols = {
            PHP: '‚Ç±', USD: '$', EUR: '‚Ç¨', GBP: '¬£', 
            JPY: '¬•', SGD: 'S$', AUD: 'A$', CAD: 'C$'
        };

        class CashTrailApp {
            constructor() {
                this.state = {
                    currency: 'PHP',
                    cashOnHand: 0,
                    withdrawals: [],
                    expenses: [],
                    adjustments: [],
                    sequenceCounter: {},
                    theme: 'dark'
                };
                this.chartInstance = null;
                this.currentReportRange = '7days';
                this.currentEditingWithdrawal = null;
                
                this.init();
            }

            init() {
                this.loadState();
                this.applyTheme();
                this.bindEvents();
                this.render();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('withdrawalDate').value = today;
                document.getElementById('expenseDate').value = today;
                document.getElementById('adjustmentDate').value = today;
                document.getElementById('reportEndDate').value = today;
                
                const lastMonth = new Date();
                lastMonth.setDate(lastMonth.getDate() - 30);
                document.getElementById('reportStartDate').value = lastMonth.toISOString().split('T')[0];
            }

            loadState() {
                try {
                    const saved = localStorage.getItem('cashtrail_state');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.state = { 
                            currency: 'PHP',
                            cashOnHand: 0,
                            withdrawals: [],
                            expenses: [],
                            adjustments: [],
                            sequenceCounter: {},
                            theme: 'dark',
                            ...parsed 
                        };
                    }
                } catch (e) {
                    console.error('State load failed:', e);
                }
            }

            saveState() {
                try {
                    localStorage.setItem('cashtrail_state', JSON.stringify(this.state));
                } catch (e) {
                    console.error('State save failed:', e);
                }
            }

            applyTheme() {
                const isDark = this.state.theme === 'dark';
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
                document.getElementById('btnTheme').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                
                const toggle = document.getElementById('themeToggle');
                if (toggle) {
                    if (isDark) {
                        toggle.classList.add('active');
                        toggle.querySelector('.theme-toggle-slider').textContent = 'üåô';
                    } else {
                        toggle.classList.remove('active');
                        toggle.querySelector('.theme-toggle-slider').textContent = '‚òÄÔ∏è';
                    }
                }
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                this.applyTheme();
                this.saveState();
            }

            bindEvents() {
                // FAB Toggle
                const fab = document.getElementById('fabMain');
                const menu = document.getElementById('fabMenu');
                
                fab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.classList.toggle('open');
                    fab.textContent = menu.classList.contains('open') ? '√ó' : '+';
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.fab-container')) {
                        menu.classList.remove('open');
                        fab.textContent = '+';
                    }
                });

                // Modal close on overlay click
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            const modalType = overlay.id.replace('modal', '').toLowerCase();
                            this.closeModal(modalType);
                        }
                    });
                });

                // Header buttons - explicit binding
                document.getElementById('btnHistory').addEventListener('click', () => {
                    this.renderFullHistory();
                    this.openModal('history');
                });

                document.getElementById('btnSettings').addEventListener('click', () => {
                    document.getElementById('settingsCurrency').value = this.state.currency;
                    this.openModal('settings');
                });

                document.getElementById('btnSearch').addEventListener('click', () => {
                    this.openModal('search');
                    setTimeout(() => document.getElementById('searchInput').focus(), 100);
                });

                document.getElementById('btnReports').addEventListener('click', () => {
                    this.openModal('reports');
                    this.generateReport();
                });

                document.getElementById('btnTheme').addEventListener('click', () => {
                    this.toggleTheme();
                });

                document.getElementById('btnViewAll').addEventListener('click', () => {
                    this.renderFullHistory();
                    this.openModal('history');
                });

                // Form inputs
                document.getElementById('withdrawalSource').addEventListener('change', (e) => {
                    this.updateWithdrawalPreview(e.target.value);
                });
                
                document.getElementById('withdrawalDate').addEventListener('change', () => {
                    const source = document.getElementById('withdrawalSource').value;
                    if (source) this.updateWithdrawalPreview(source);
                });

                document.getElementById('adjustmentAmount').addEventListener('input', (e) => {
                    this.calculateAdjustment(e.target.value);
                });
            }

            openModal(type) {
                const modalMap = {
                    'withdrawal': 'modalWithdrawal',
                    'expense': 'modalExpense',
                    'adjustment': 'modalAdjustment',
                    'search': 'modalSearch',
                    'reports': 'modalReports',
                    'settings': 'modalSettings',
                    'history': 'modalHistory',
                    'withdrawalDetails': 'modalWithdrawalDetails'
                };
                
                const modalId = modalMap[type];
                const modal = document.getElementById(modalId);
                
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    if (type === 'expense') {
                        this.renderSourceSelector();
                    } else if (type === 'adjustment') {
                        this.prepareAdjustmentModal();
                    }
                }
            }

            closeModal(type) {
                const modalMap = {
                    'withdrawal': 'modalWithdrawal',
                    'expense': 'modalExpense',
                    'adjustment': 'modalAdjustment',
                    'search': 'modalSearch',
                    'reports': 'modalReports',
                    'settings': 'modalSettings',
                    'history': 'modalHistory',
                    'withdrawalDetails': 'modalWithdrawalDetails'
                };
                
                const modalId = modalMap[type];
                const modal = document.getElementById(modalId);
                
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                    
                    // Reset forms
                    if (['withdrawal', 'expense', 'adjustment'].includes(type)) {
                        this.resetForm(type);
                    }
                }
                
                // Close FAB menu
                document.getElementById('fabMenu').classList.remove('open');
                document.getElementById('fabMain').textContent = '+';
            }

            resetForm(type) {
                const form = document.getElementById(`${type}Form`);
                if (form) form.reset();
                
                document.getElementById(`${type}EditId`).value = '';
                document.getElementById(`${type}ModalTitle`).textContent = 
                    type === 'withdrawal' ? 'Record Withdrawal' : 
                    type === 'expense' ? 'Record Expense' : 'Adjust Cash on Hand';
                
                const submitBtn = document.getElementById(`${type}SubmitBtn`);
                const editActions = document.getElementById(`${type}EditActions`);
                
                if (submitBtn) submitBtn.style.display = 'block';
                if (editActions) editActions.style.display = 'none';
                
                if (type === 'withdrawal') {
                    document.getElementById('withdrawalIdHint').style.display = 'block';
                }
                
                // Reset date to today
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById(`${type}Date`);
                if (dateInput) dateInput.value = today;
            }

            editTransaction(type, id) {
                let item;
                if (type === 'withdrawal') {
                    item = this.state.withdrawals.find(w => w.id === id);
                } else if (type === 'expense') {
                    item = this.state.expenses.find(e => e.id === id);
                } else if (type === 'adjustment') {
                    item = this.state.adjustments.find(a => a.id === id);
                }

                if (!item) {
                    console.error('Item not found:', type, id);
                    return;
                }

                this.openModal(type);
                
                // Set edit mode
                document.getElementById(`${type}EditId`).value = id;
                document.getElementById(`${type}ModalTitle`).textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                document.getElementById(`${type}SubmitBtn`).style.display = 'none';
                document.getElementById(`${type}EditActions`).style.display = 'flex';

                // Populate fields
                if (type === 'withdrawal') {
                    document.getElementById('withdrawalAmount').value = item.amount;
                    document.getElementById('withdrawalSource').value = item.source;
                    document.getElementById('withdrawalDate').value = item.date;
                    document.getElementById('withdrawalRef').value = item.reference || '';
                    document.getElementById('withdrawalIdHint').style.display = 'none';
                } else if (type === 'expense') {
                    document.getElementById('expenseAmount').value = item.amount;
                    document.getElementById('expenseCategory').value = item.category;
                    document.getElementById('expenseNote').value = item.note || '';
                    document.getElementById('expenseDate').value = item.date;
                    document.getElementById('selectedWithdrawalId').value = item.withdrawalId;
                    
                    this.renderSourceSelector(item.withdrawalId);
                } else if (type === 'adjustment') {
                    document.getElementById('adjustmentAmount').value = item.newBalance;
                    document.getElementById('adjustmentReason').value = item.reason;
                    document.getElementById('adjustmentNote').value = item.note || '';
                    document.getElementById('adjustmentDate').value = item.date;
                    this.calculateAdjustment(item.newBalance);
                }
            }

            showWithdrawalDetails(withdrawalId) {
                this.currentEditingWithdrawal = withdrawalId;
                const w = this.state.withdrawals.find(w => w.id === withdrawalId);
                if (!w) return;

                const expenses = this.state.expenses.filter(e => e.withdrawalId === withdrawalId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                document.getElementById('withdrawalDetailsTitle').textContent = `Withdrawal ${withdrawalId}`;
                
                const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
                const progress = ((w.amount - w.remaining) / w.amount) * 100;

                document.getElementById('withdrawalDetailsContent').innerHTML = `
                    <div style="background: var(--bg-primary); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid var(--border-subtle); margin-bottom: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                            <span style="color: var(--text-secondary);">Amount:</span>
                            <span style="font-weight: 600;">${this.formatMoney(w.amount)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                            <span style="color: var(--text-secondary);">Spent:</span>
                            <span style="font-weight: 600; color: var(--accent-danger);">${this.formatMoney(totalSpent)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                            <span style="color: var(--text-secondary);">Remaining:</span>
                            <span style="font-weight: 600; color: var(--accent-success);">${this.formatMoney(w.remaining)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Date:</span>
                            <span>${this.formatDateLong(w.date)}</span>
                        </div>
                        <div style="margin-top: var(--spacing-md);">
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: var(--spacing-xs);">
                                <span>Progress</span>
                                <span>${progress.toFixed(0)}%</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                                <div style="width: ${progress}%; height: 100%; background: ${progress >= 100 ? 'var(--accent-success)' : 'var(--accent-primary)'}; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <button type="button" class="btn btn-secondary" onclick="app.editTransaction('withdrawal', '${w.id}')" style="flex: 1; font-size: 0.875rem; padding: var(--spacing-sm);">‚úèÔ∏è Edit Withdrawal</button>
                        <button type="button" class="btn btn-primary" onclick="app.addExpenseToWithdrawal('${w.id}')" style="flex: 1; font-size: 0.875rem; padding: var(--spacing-sm);">‚ûï Add Expense</button>
                    </div>
                    <h4 style="margin-bottom: var(--spacing-md); color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Linked Expenses (${expenses.length})</h4>
                `;

                if (expenses.length === 0) {
                    document.getElementById('withdrawalExpensesList').innerHTML = `
                        <div class="empty-state" style="padding: var(--spacing-lg);">
                            <div style="font-size: 2rem; opacity: 0.5;">üìù</div>
                            <div style="font-size: 0.875rem;">No expenses linked to this withdrawal yet</div>
                        </div>
                    `;
                } else {
                    document.getElementById('withdrawalExpensesList').innerHTML = expenses.map(e => `
                        <div class="history-item" onclick="app.editExpenseFromDetails('${e.id}')">
                            <div class="history-type expense">üí∏</div>
                            <div class="history-details">
                                <div class="history-title">${e.category}${e.note ? ` ‚Ä¢ ${e.note}` : ''}</div>
                                <div class="history-meta">${this.formatDate(e.date)}</div>
                            </div>
                            <div class="history-amount negative">-${this.formatMoney(e.amount)}</div>
                        </div>
                    `).join('');
                }

                this.openModal('withdrawalDetails');
            }

            addExpenseToWithdrawal(withdrawalId) {
                this.closeModal('withdrawalDetails');
                setTimeout(() => {
                    this.openModal('expense');
                    document.getElementById('selectedWithdrawalId').value = withdrawalId;
                    this.renderSourceSelector(withdrawalId);
                }, 300);
            }

            editExpenseFromDetails(expenseId) {
                this.closeModal('withdrawalDetails');
                setTimeout(() => {
                    this.editTransaction('expense', expenseId);
                }, 300);
            }

            deleteTransaction(type, id) {
                if (!confirm('Are you sure you want to delete this transaction? This cannot be undone.')) return;

                if (type === 'withdrawal') {
                    const idx = this.state.withdrawals.findIndex(w => w.id === id);
                    if (idx > -1) {
                        const w = this.state.withdrawals[idx];
                        const hasExpenses = this.state.expenses.some(e => e.withdrawalId === id);
                        if (hasExpenses) {
                            alert('Cannot delete withdrawal with linked expenses. Delete expenses first or reassign them.');
                            return;
                        }
                        this.state.cashOnHand -= w.remaining;
                        this.state.withdrawals.splice(idx, 1);
                    }
                } else if (type === 'expense') {
                    const idx = this.state.expenses.findIndex(e => e.id === id);
                    if (idx > -1) {
                        const e = this.state.expenses[idx];
                        
                        if (e.withdrawalId === 'CASH_ON_HAND') {
                            this.state.cashOnHand += e.amount;
                        } else {
                            const w = this.state.withdrawals.find(w => w.id === e.withdrawalId);
                            if (w) {
                                w.remaining += e.amount;
                                w.consumed = false;
                            }
                        }
                        
                        this.state.expenses.splice(idx, 1);
                    }
                } else if (type === 'adjustment') {
                    const idx = this.state.adjustments.findIndex(a => a.id === id);
                    if (idx > -1) {
                        const a = this.state.adjustments[idx];
                        this.state.cashOnHand -= a.difference;
                        this.state.adjustments.splice(idx, 1);
                    }
                }

                this.saveState();
                this.render();
                this.closeModal(type);
                this.showNotification('Transaction deleted');
            }

            handleWithdrawalSubmit(e) {
                e.preventDefault();
                const editId = document.getElementById('withdrawalEditId').value;
                const amount = parseFloat(document.getElementById('withdrawalAmount').value);
                const source = document.getElementById('withdrawalSource').value;
                const date = document.getElementById('withdrawalDate').value;
                const ref = document.getElementById('withdrawalRef').value;

                if (editId) {
                    // Edit mode
                    const w = this.state.withdrawals.find(w => w.id === editId);
                    if (w) {
                        const diff = amount - w.amount;
                        w.amount = amount;
                        w.source = source;
                        w.date = date;
                        w.reference = ref;
                        w.remaining += diff;
                        this.state.cashOnHand += diff;
                    }
                } else {
                    // Create new
                    const formattedDate = date.replace(/-/g, '').slice(2);
                    const existing = this.state.withdrawals.filter(w => w.id.startsWith(`${source}-${formattedDate}`)).length;
                    const sequence = String(existing + 1).padStart(3, '0');
                    const controlNumber = `${source}-${formattedDate}-${sequence}`;

                    const withdrawal = {
                        id: controlNumber,
                        type: 'withdrawal',
                        amount: amount,
                        source: source,
                        date: date,
                        reference: ref,
                        remaining: amount,
                        consumed: false,
                        createdAt: new Date().toISOString()
                    };

                    this.state.withdrawals.unshift(withdrawal);
                    this.state.cashOnHand += amount;
                }

                this.saveState();
                this.render();
                this.closeModal('withdrawal');
                this.showNotification(editId ? 'Withdrawal updated' : 'Withdrawal recorded');
            }

            handleExpenseSubmit(e) {
                e.preventDefault();
                const editId = document.getElementById('expenseEditId').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const withdrawalId = document.getElementById('selectedWithdrawalId').value;
                const category = document.getElementById('expenseCategory').value;
                const note = document.getElementById('expenseNote').value;
                const date = document.getElementById('expenseDate').value;

                if (!withdrawalId) {
                    alert('Please select a source');
                    return;
                }

                const isCashOnHand = withdrawalId === 'CASH_ON_HAND';
                
                if (!isCashOnHand) {
                    const withdrawal = this.state.withdrawals.find(w => w.id === withdrawalId);
                    if (!withdrawal) {
                        alert('Selected withdrawal not found');
                        return;
                    }
                }

                if (editId) {
                    // Edit mode
                    const e = this.state.expenses.find(ex => ex.id === editId);
                    if (e) {
                        const oldWasCash = e.withdrawalId === 'CASH_ON_HAND';
                        const newIsCash = withdrawalId === 'CASH_ON_HAND';
                        const amountDiff = amount - e.amount;

                        if (oldWasCash && newIsCash) {
                            if (this.state.cashOnHand < amountDiff) {
                                alert('Insufficient cash on hand');
                                return;
                            }
                            this.state.cashOnHand -= amountDiff;
                            e.amount = amount;
                        } else if (oldWasCash && !newIsCash) {
                            const w = this.state.withdrawals.find(w => w.id === withdrawalId);
                            if (w.remaining < amount) {
                                alert('Insufficient balance in selected withdrawal');
                                return;
                            }
                            this.state.cashOnHand += e.amount;
                            w.remaining -= amount;
                            if (w.remaining <= 0) w.consumed = true;
                            e.withdrawalId = withdrawalId;
                            e.amount = amount;
                        } else if (!oldWasCash && newIsCash) {
                            const oldW = this.state.withdrawals.find(w => w.id === e.withdrawalId);
                            if (this.state.cashOnHand < amount) {
                                alert('Insufficient cash on hand');
                                return;
                            }
                            oldW.remaining += e.amount;
                            oldW.consumed = false;
                            this.state.cashOnHand -= amount;
                            e.withdrawalId = withdrawalId;
                            e.amount = amount;
                        } else {
                            if (e.withdrawalId === withdrawalId) {
                                const w = this.state.withdrawals.find(w => w.id === withdrawalId);
                                if (w.remaining < amountDiff) {
                                    alert('Insufficient balance in selected withdrawal');
                                    return;
                                }
                                w.remaining -= amountDiff;
                                if (w.remaining <= 0) w.consumed = true;
                                else w.consumed = false;
                                e.amount = amount;
                            } else {
                                const oldW = this.state.withdrawals.find(w => w.id === e.withdrawalId);
                                const newW = this.state.withdrawals.find(w => w.id === withdrawalId);
                                if (newW.remaining < amount) {
                                    alert('Insufficient balance in selected withdrawal');
                                    return;
                                }
                                oldW.remaining += e.amount;
                                oldW.consumed = false;
                                newW.remaining -= amount;
                                if (newW.remaining <= 0) newW.consumed = true;
                                e.withdrawalId = withdrawalId;
                                e.amount = amount;
                            }
                        }
                        
                        e.category = category;
                        e.note = note;
                        e.date = date;
                    }
                } else {
                    // Create new
                    if (isCashOnHand) {
                        if (this.state.cashOnHand < amount) {
                            alert('Insufficient cash on hand');
                            return;
                        }
                        this.state.cashOnHand -= amount;
                    } else {
                        const withdrawal = this.state.withdrawals.find(w => w.id === withdrawalId);
                        if (withdrawal.remaining < amount) {
                            alert('Insufficient balance in selected withdrawal');
                            return;
                        }
                        withdrawal.remaining -= amount;
                        if (withdrawal.remaining <= 0) withdrawal.consumed = true;
                    }

                    const expense = {
                        id: `EXP-${Date.now()}`,
                        type: 'expense',
                        amount: amount,
                        category: category,
                        note: note,
                        date: date,
                        withdrawalId: withdrawalId,
                        createdAt: new Date().toISOString()
                    };

                    this.state.expenses.unshift(expense);
                }

                this.saveState();
                this.render();
                this.closeModal('expense');
                this.showNotification(editId ? 'Expense updated' : 'Expense recorded');
            }

            handleAdjustmentSubmit(e) {
                e.preventDefault();
                const editId = document.getElementById('adjustmentEditId').value;
                const actualAmount = parseFloat(document.getElementById('adjustmentAmount').value);
                const reason = document.getElementById('adjustmentReason').value;
                const note = document.getElementById('adjustmentNote').value;
                const date = document.getElementById('adjustmentDate').value;

                if (editId) {
                    const a = this.state.adjustments.find(adj => adj.id === editId);
                    if (a) {
                        this.state.cashOnHand -= a.difference;
                        const newDiff = actualAmount - a.previousBalance;
                        a.newBalance = actualAmount;
                        a.difference = newDiff;
                        a.reason = reason;
                        a.note = note;
                        a.date = date;
                        this.state.cashOnHand += newDiff;
                    }
                } else {
                    const previousBalance = this.state.cashOnHand;
                    const difference = actualAmount - previousBalance;

                    const adjustment = {
                        id: `ADJ-${Date.now()}`,
                        type: 'adjustment',
                        previousBalance: previousBalance,
                        newBalance: actualAmount,
                        difference: difference,
                        reason: reason,
                        note: note,
                        date: date,
                        createdAt: new Date().toISOString()
                    };

                    this.state.cashOnHand = actualAmount;
                    this.state.adjustments.unshift(adjustment);
                }

                this.saveState();
                this.render();
                this.closeModal('adjustment');
                this.showNotification(editId ? 'Adjustment updated' : 'Cash adjusted');
            }

            renderSourceSelector(selectedId = null) {
                const container = document.getElementById('expenseSourceSelector');
                
                const options = [];
                
                // Cash on Hand option
                options.push({
                    id: 'CASH_ON_HAND',
                    displayId: 'üíµ CASH ON HAND',
                    balance: this.state.cashOnHand,
                    source: 'Direct Cash',
                    isCash: true,
                    disabled: this.state.cashOnHand <= 0 && selectedId !== 'CASH_ON_HAND'
                });
                
                // Active withdrawals
                this.state.withdrawals
                    .filter(w => w.remaining > 0 || w.id === selectedId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(w => {
                        options.push({
                            id: w.id,
                            displayId: w.id,
                            balance: w.remaining,
                            source: w.source,
                            isCash: false,
                            disabled: false
                        });
                    });

                if (options.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--spacing-md);">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">‚ö†Ô∏è</div>
                            <div>No funding sources available.</div>
                            <div style="font-size: 0.875rem; margin-top: var(--spacing-xs);">
                                Record a withdrawal first.
                            </div>
                        </div>
                    `;
                    const submitBtn = document.getElementById('expenseSubmitBtn');
                    if (submitBtn) submitBtn.disabled = true;
                    return;
                }

                const submitBtn = document.getElementById('expenseSubmitBtn');
                if (submitBtn) submitBtn.disabled = false;

                container.innerHTML = options.map(opt => `
                    <div class="source-option ${opt.isCash ? 'cash-option' : ''} ${selectedId === opt.id ? 'selected' : ''} ${opt.disabled ? 'disabled' : ''}" 
                         ${opt.disabled ? '' : `onclick="app.selectWithdrawalSource('${opt.id}', this)"`}
                         style="${opt.disabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <div class="source-info">
                            <div class="source-id">${opt.displayId}</div>
                            <div class="source-balance">
                                ${opt.isCash ? 'Available: ' : 'Remaining: '}${this.formatMoney(opt.balance)} 
                                ${opt.isCash ? '' : ' ‚Ä¢ ' + opt.source}
                            </div>
                        </div>
                        <div class="source-radio"></div>
                    </div>
                `).join('');
                
                if (selectedId) {
                    document.getElementById('selectedWithdrawalId').value = selectedId;
                }
            }

            selectWithdrawalSource(id, element) {
                // Remove selected from all
                document.querySelectorAll('.source-option').forEach(el => el.classList.remove('selected'));
                // Add to clicked
                element.classList.add('selected');
                // Set value
                document.getElementById('selectedWithdrawalId').value = id;
            }

            updateWithdrawalPreview(source) {
                if (!source) return;
                const date = document.getElementById('withdrawalDate').value || new Date().toISOString().split('T')[0];
                const formattedDate = date.replace(/-/g, '').slice(2);
                const existing = this.state.withdrawals.filter(w => w.id.startsWith(`${source}-${formattedDate}`)).length;
                const sequence = String(existing + 1).padStart(3, '0');
                const previewId = `${source}-${formattedDate}-${sequence}`;
                
                const hint = document.getElementById('previewId');
                if (hint) hint.textContent = previewId;
            }

            prepareAdjustmentModal() {
                const balanceEl = document.getElementById('currentRecordedBalance');
                if (balanceEl) {
                    balanceEl.textContent = `${CurrencySymbols[this.state.currency]}${this.state.cashOnHand.toFixed(2)}`;
                }
                const preview = document.getElementById('adjustmentPreview');
                if (preview) preview.classList.add('hidden');
            }

            calculateAdjustment(actualAmount) {
                const current = this.state.cashOnHand;
                const actual = parseFloat(actualAmount) || 0;
                const diff = actual - current;
                
                const preview = document.getElementById('adjustmentPreview');
                const value = document.getElementById('adjustmentValue');
                
                if (!preview || !value) return;
                
                if (actualAmount === '') {
                    preview.classList.add('hidden');
                    return;
                }
                
                preview.classList.remove('hidden');
                const symbol = CurrencySymbols[this.state.currency];
                
                if (diff > 0) {
                    value.textContent = `+${symbol}${diff.toFixed(2)} (Cash increased)`;
                    value.style.color = 'var(--accent-success)';
                } else if (diff < 0) {
                    value.textContent = `${symbol}${diff.toFixed(2)} (Cash decreased)`;
                    value.style.color = 'var(--accent-danger)';
                } else {
                    value.textContent = `No adjustment needed`;
                    value.style.color = 'var(--text-secondary)';
                }
            }

            handleSearch(query) {
                const container = document.getElementById('searchResults');
                if (!query.trim()) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <div>Type to search transactions</div>
                        </div>
                    `;
                    return;
                }

                const q = query.toLowerCase();
                const results = [];

                this.state.withdrawals.forEach(w => {
                    if (w.id.toLowerCase().includes(q) || 
                        w.source.toLowerCase().includes(q) ||
                        w.amount.toString().includes(q) ||
                        (w.reference && w.reference.toLowerCase().includes(q))) {
                        results.push({...w, displayType: 'withdrawal'});
                    }
                });

                this.state.expenses.forEach(e => {
                    if (e.category.toLowerCase().includes(q) || 
                        (e.note && e.note.toLowerCase().includes(q)) ||
                        e.amount.toString().includes(q) ||
                        e.withdrawalId.toLowerCase().includes(q)) {
                        results.push({...e, displayType: 'expense'});
                    }
                });

                this.state.adjustments.forEach(a => {
                    if (a.reason.toLowerCase().includes(q) || 
                        (a.note && a.note.toLowerCase().includes(q)) ||
                        a.difference.toString().includes(q)) {
                        results.push({...a, displayType: 'adjustment'});
                    }
                });

                results.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üòï</div>
                            <div>No results found</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = results.map(t => this.renderSearchResult(t)).join('');
            }

            renderSearchResult(t) {
                const isWithdrawal = t.displayType === 'withdrawal';
                const isExpense = t.displayType === 'expense';
                
                let icon, title, meta, amount, amountClass;
                
                if (isWithdrawal) {
                    icon = '‚¨áÔ∏è';
                    title = `${t.source} Withdrawal`;
                    meta = `${t.id} ‚Ä¢ ${this.formatDate(t.date)}`;
                    amount = `+${this.formatMoney(t.amount)}`;
                    amountClass = 'positive';
                } else if (isExpense) {
                    icon = 'üí∏';
                    title = t.category;
                    meta = `${t.note || 'No note'} ‚Ä¢ From: ${t.withdrawalId} ‚Ä¢ ${this.formatDate(t.date)}`;
                    amount = `-${this.formatMoney(t.amount)}`;
                    amountClass = 'negative';
                } else {
                    icon = t.difference > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                    title = `Adjustment: ${t.reason}`;
                    meta = `${t.note || ''} ‚Ä¢ ${this.formatDate(t.date)}`;
                    amount = `${t.difference > 0 ? '+' : ''}${this.formatMoney(t.difference)}`;
                    amountClass = t.difference > 0 ? 'positive' : 'negative';
                }

                return `
                    <div class="history-item animate-in" onclick="app.editTransaction('${t.displayType}', '${t.id}')">
                        <div class="history-type ${t.displayType}">${icon}</div>
                        <div class="history-details">
                            <div class="history-title">${title}</div>
                            <div class="history-meta">${meta}</div>
                        </div>
                        <div class="history-amount ${amountClass}">${amount}</div>
                    </div>
                `;
            }

            setReportRange(range) {
                this.currentReportRange = range;
                
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                event.target.classList.add('active');

                const customRange = document.getElementById('customDateRange');
                if (range === 'custom') {
                    customRange.classList.remove('hidden');
                } else {
                    customRange.classList.add('hidden');
                    this.generateReport();
                }
            }

            generateReport() {
                let startDate, endDate;
                const today = new Date();
                endDate = today;

                switch(this.currentReportRange) {
                    case '7days':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case '30days':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 30);
                        break;
                    case '90days':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 90);
                        break;
                    case '1year':
                        startDate = new Date(today);
                        startDate.setFullYear(today.getFullYear() - 1);
                        break;
                    case 'custom':
                        startDate = new Date(document.getElementById('reportStartDate').value);
                        endDate = new Date(document.getElementById('reportEndDate').value);
                        if (!startDate || !endDate) return;
                        break;
                }

                const filteredExpenses = this.state.expenses.filter(e => {
                    const d = new Date(e.date);
                    return d >= startDate && d <= endDate;
                });

                const totalSpent = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                const transactionCount = filteredExpenses.length;
                
                const daysDiff = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)));
                const dailyAvg = totalSpent / daysDiff;

                const categoryTotals = {};
                filteredExpenses.forEach(e => {
                    categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
                });

                const topCategory = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])[0];

                document.getElementById('reportTotalSpent').textContent = this.formatMoney(totalSpent);
                document.getElementById('reportTransactionCount').textContent = transactionCount;
                document.getElementById('reportDailyAvg').textContent = this.formatMoney(dailyAvg);
                document.getElementById('reportTopCategory').textContent = topCategory ? topCategory[0] : '-';

                this.renderChart(categoryTotals);
                this.renderCategoryBreakdown(categoryTotals, totalSpent);
            }

            renderChart(categoryTotals) {
                const ctx = document.getElementById('spendingChart').getContext('2d');
                
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                }

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const colors = [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                    '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                ];

                const isDark = this.state.theme === 'dark';
                
                this.chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: isDark ? '#94a3b8' : '#64748b',
                                    font: { size: 11 },
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                backgroundColor: isDark ? '#1e293b' : '#ffffff',
                                titleColor: isDark ? '#f8fafc' : '#0f172a',
                                bodyColor: isDark ? '#f8fafc' : '#0f172a',
                                borderColor: isDark ? '#475569' : '#cbd5e1',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => {
                                        const val = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const pct = ((val / total) * 100).toFixed(1);
                                        return `${context.label}: ${this.formatMoney(val)} (${pct}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCategoryBreakdown(categoryTotals, total) {
                const container = document.getElementById('categoryBreakdown');
                const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
                
                container.innerHTML = sorted.map(([cat, amount]) => {
                    const pct = ((amount / total) * 100).toFixed(1);
                    return `
                        <div class="history-item" style="margin-bottom: var(--spacing-sm);">
                            <div class="history-details">
                                <div class="history-title">${cat}</div>
                                <div class="history-meta">${pct}% of total spending</div>
                            </div>
                            <div class="history-amount negative">${this.formatMoney(amount)}</div>
                        </div>
                    `;
                }).join('');
            }

            render() {
                this.renderCashHero();
                this.renderWithdrawals();
                this.renderRecentActivity();
            }

            renderCashHero() {
                document.getElementById('cashAmount').textContent = this.state.cashOnHand.toFixed(2);
                document.getElementById('currencyDisplay').textContent = this.state.currency;
                
                const active = this.state.withdrawals.filter(w => !w.consumed).length;
                document.getElementById('activeWithdrawals').textContent = 
                    `${active} active withdrawal${active !== 1 ? 's' : ''}`;
                
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const recentExpenses = this.state.expenses.filter(e => new Date(e.date) >= sevenDaysAgo);
                const totalSpent = recentExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                const trendEl = document.getElementById('trendIndicator');
                if (totalSpent > 0) {
                    trendEl.innerHTML = `<span>üìâ</span><span>${this.formatMoney(totalSpent)} spent (7d)</span>`;
                    trendEl.className = 'meta-item negative';
                } else {
                    trendEl.innerHTML = `<span>‚úì</span><span>No recent expenses</span>`;
                    trendEl.className = 'meta-item positive';
                }
            }

            renderWithdrawals() {
                const container = document.getElementById('withdrawalsContainer');
                const activeWithdrawals = this.state.withdrawals.filter(w => !w.consumed);
                
                if (activeWithdrawals.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üí≥</div>
                            <div>No active withdrawals</div>
                            <div style="font-size: 0.875rem; margin-top: var(--spacing-sm);">
                                Record a withdrawal to start tracking
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = activeWithdrawals.map(w => {
                    const linkedExpenses = this.state.expenses.filter(e => e.withdrawalId === w.id);
                    const progress = ((w.amount - w.remaining) / w.amount) * 100;
                    
                    return `
                        <div class="withdrawal-card ${w.consumed ? 'consumed' : ''}">
                            <div class="withdrawal-header" onclick="app.showWithdrawalDetails('${w.id}')">
                                <div>
                                    <div class="withdrawal-id">${w.id}</div>
                                    <div class="withdrawal-source">
                                        <span>üè¶</span>
                                        <span>${w.source} ‚Ä¢ ${this.formatDate(w.date)}</span>
                                    </div>
                                </div>
                                <div class="withdrawal-amounts">
                                    <div class="withdrawal-total">${this.formatMoney(w.amount)}</div>
                                    <div class="withdrawal-remaining ${w.consumed ? 'depleted' : ''}">
                                        ${this.formatMoney(w.remaining)} left
                                    </div>
                                </div>
                            </div>
                            <div class="withdrawal-actions">
                                <button type="button" class="btn-small" onclick="event.stopPropagation(); app.showWithdrawalDetails('${w.id}')">
                                    üìã Details (${linkedExpenses.length})
                                </button>
                                <button type="button" class="btn-small" onclick="event.stopPropagation(); app.editTransaction('withdrawal', '${w.id}')">
                                    ‚úèÔ∏è Edit
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderRecentActivity() {
                const container = document.getElementById('recentActivityContainer');
                const allTransactions = [
                    ...this.state.withdrawals.map(w => ({...w, displayType: 'withdrawal'})),
                    ...this.state.expenses.map(e => ({...e, displayType: 'expense'})),
                    ...this.state.adjustments.map(a => ({...a, displayType: 'adjustment'}))
                ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
                
                if (allTransactions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--spacing-lg);">
                            <div style="font-size: 1.5rem; opacity: 0.5;">üìù</div>
                            <div style="font-size: 0.875rem; margin-top: var(--spacing-sm);">No transactions yet</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = allTransactions.map(t => {
                    const isWithdrawal = t.displayType === 'withdrawal';
                    const isExpense = t.displayType === 'expense';
                    
                    let icon, title, meta, amount, amountClass;
                    
                    if (isWithdrawal) {
                        icon = '‚¨áÔ∏è';
                        title = `Withdrawal from ${t.source}`;
                        meta = t.id;
                        amount = `+${this.formatMoney(t.amount)}`;
                        amountClass = 'positive';
                    } else if (isExpense) {
                        icon = 'üí∏';
                        title = `${t.category}`;
                        meta = `From ${t.withdrawalId} ‚Ä¢ ${this.formatDate(t.date)}`;
                        amount = `-${this.formatMoney(t.amount)}`;
                        amountClass = 'negative';
                    } else {
                        icon = t.difference > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                        title = `Cash Adjustment`;
                        meta = t.reason;
                        amount = `${t.difference > 0 ? '+' : ''}${this.formatMoney(t.difference)}`;
                        amountClass = t.difference > 0 ? 'positive' : 'negative';
                    }
                    
                    return `
                        <div class="history-item animate-in" onclick="app.editTransaction('${t.displayType}', '${t.id}')">
                            <div class="history-type ${t.displayType}">${icon}</div>
                            <div class="history-details">
                                <div class="history-title">${title}</div>
                                <div class="history-meta">${meta}</div>
                            </div>
                            <div class="history-amount ${amountClass}">${amount}</div>
                        </div>
                    `;
                }).join('');
            }

            renderFullHistory() {
                const container = document.getElementById('fullHistoryList');
                const allTransactions = [
                    ...this.state.withdrawals.map(w => ({...w, displayType: 'withdrawal'})),
                    ...this.state.expenses.map(e => ({...e, displayType: 'expense'})),
                    ...this.state.adjustments.map(a => ({...a, displayType: 'adjustment'}))
                ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (allTransactions.length === 0) {
                    container.innerHTML = '<div class="empty-state">No transaction history</div>';
                    return;
                }
                
                const grouped = allTransactions.reduce((acc, t) => {
                    const date = t.date;
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(t);
                    return acc;
                }, {});
                
                container.innerHTML = Object.entries(grouped).map(([date, transactions]) => `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--spacing-sm); padding-left: var(--spacing-sm);">
                            ${this.formatDateLong(date)}
                        </div>
                        ${transactions.map(t => {
                            const isWithdrawal = t.displayType === 'withdrawal';
                            const isExpense = t.displayType === 'expense';
                            
                            let icon, title, subtitle, amount, amountClass;
                            
                            if (isWithdrawal) {
                                icon = '‚¨áÔ∏è';
                                title = `Withdrawal ‚Ä¢ ${t.source}`;
                                subtitle = t.id;
                                amount = `+${this.formatMoney(t.amount)}`;
                                amountClass = 'positive';
                            } else if (isExpense) {
                                icon = 'üí∏';
                                title = `${t.category}${t.note ? ` ‚Ä¢ ${t.note}` : ''}`;
                                subtitle = `From: ${t.withdrawalId}`;
                                amount = `-${this.formatMoney(t.amount)}`;
                                amountClass = 'negative';
                            } else {
                                icon = t.difference > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                                title = `Adjustment ‚Ä¢ ${t.reason}`;
                                subtitle = `Recorded: ${this.formatMoney(t.previousBalance)} ‚Üí ${this.formatMoney(t.newBalance)}`;
                                amount = `${t.difference > 0 ? '+' : ''}${this.formatMoney(t.difference)}`;
                                amountClass = t.difference > 0 ? 'positive' : 'negative';
                            }
                            
                            return `
                                <div class="history-item" style="margin-bottom: var(--spacing-sm);" onclick="app.editTransaction('${t.displayType}', '${t.id}')">
                                    <div class="history-type ${t.displayType}">${icon}</div>
                                    <div class="history-details">
                                        <div class="history-title">${title}</div>
                                        <div class="history-meta">${subtitle}</div>
                                    </div>
                                    <div class="history-amount ${amountClass}">${amount}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `).join('');
            }

            formatMoney(amount) {
                const symbol = CurrencySymbols[this.state.currency];
                return `${symbol}${Math.abs(amount).toFixed(2)}`;
            }

            formatDate(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) return 'Today';
                if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
                
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            formatDateLong(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                
                if (date.toDateString() === today.toDateString()) return 'Today';
                
                return date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }

            showNotification(message) {
                console.log('Notification:', message);
            }

            updateCurrency(currency) {
                this.state.currency = currency;
                this.saveState();
                this.render();
                if (this.chartInstance) this.generateReport();
                this.showNotification(`Currency changed to ${currency}`);
            }

            exportData() {
                const dataStr = JSON.stringify(this.state, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `cashtrail-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                this.showNotification('Data exported successfully');
            }

            importData() {
                document.getElementById('importFile').click();
            }

            handleImport(input) {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        
                        if (!imported.withdrawals || !imported.expenses || typeof imported.cashOnHand !== 'number') {
                            throw new Error('Invalid backup file format');
                        }
                        
                        if (confirm('This will replace all current data. Continue?')) {
                            this.state = { ...this.state, ...imported };
                            this.applyTheme();
                            this.saveState();
                            this.render();
                            this.showNotification('Data imported successfully');
                        }
                    } catch (err) {
                        alert('Failed to import: ' + err.message);
                    }
                };
                reader.readAsText(file);
                input.value = '';
            }

            clearAllData() {
                if (confirm('‚ö†Ô∏è WARNING: This will permanently delete all your data. Are you sure?')) {
                    if (confirm('Double-check: All withdrawals, expenses, and adjustments will be lost. Continue?')) {
                        this.state = {
                            currency: this.state.currency,
                            cashOnHand: 0,
                            withdrawals: [],
                            expenses: [],
                            adjustments: [],
                            sequenceCounter: {},
                            theme: this.state.theme
                        };
                        this.saveState();
                        this.render();
                        this.closeModal('settings');
                        this.showNotification('All data cleared');
                    }
                }
            }
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new CashTrailApp();
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((reg) => console.log('SW registered:', reg.scope))
      .catch((err) => console.log('SW failed:', err));
  });
}
    </script>
</body>
</html>